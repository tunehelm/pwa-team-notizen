---
description: Projekt-Wissen PWA Team Notizen — Datenbank, RLS, Berechtigungen, Architektur
alwaysApply: true
---

# Projekt-Wissen: PWA Team Notizen

## Supabase-Tabellen

### `folders`
| Spalte | Typ | Beschreibung |
|--------|-----|-------------|
| id | uuid | Primary Key |
| title | text | Ordnername |
| pinned | boolean | (veraltet – wird durch `user_pins` ersetzt) |
| created_at | timestamp | Erstellzeitpunkt |
| owner_id | uuid | Ersteller (auth.uid) |
| parent_id | uuid / null | Elternordner (null = Root) |
| kind | text | `'team'`, `'private'`, `'readonly'` |
| icon | text / null | Custom Icon ID (wird aktuell nicht mehr genutzt — alle Ordner zeigen einheitliches Ordner-Icon) |

### `notes`
| Spalte | Typ | Beschreibung |
|--------|-----|-------------|
| id | uuid | Primary Key |
| folder_id | uuid | Zugehöriger Ordner |
| title | text | Notiz-Titel |
| content | text | HTML-Inhalt (contenteditable) |
| excerpt | text | Kurzvorschau |
| updated_label | text | Zeitstempel-Label |
| pinned | boolean | (veraltet – wird durch `user_pins` ersetzt) |
| owner_id / user_id | uuid | Ersteller |

### `trash_folders` / `trash_notes`
Gleiche Struktur + `deleted_at` timestamp. Papierkorb-Logik: Soft-Delete per Upsert.

### `profiles`
| Spalte | Typ | Beschreibung |
|--------|-----|-------------|
| id | uuid | PK, referenziert auth.users |
| email | text | E-Mail des Users |
| display_name | text | Anzeigename |
| updated_at | timestamptz | Letzte Aktualisierung |

- Wird automatisch per Trigger (`on_auth_user_created`) bei Registrierung erstellt
- Wird bei Login und Namensänderung per Upsert aktualisiert (`AppDataContext.tsx`, `Sidebar.tsx`)
- RLS: Jeder kann alle Profile lesen, nur eigenes updaten/inserten
- SQL-Setup: `docs/supabase-profiles-setup.sql`

### `messages`
| Spalte | Typ | Beschreibung |
|--------|-----|-------------|
| id | uuid | PK |
| sender_id | uuid | Absender (auth.uid) |
| sender_name | text | Name des Absenders |
| sender_email | text | E-Mail des Absenders |
| content | text | Nachrichtentext |
| created_at | timestamptz | Zeitstempel |
| read | boolean | Gelesen-Status |

- Team-Mitglieder senden Nachrichten an Admin über Team-Seite
- Admin sieht alle Nachrichten mit Ungelesen-Badge, kann als gelesen markieren
- RLS: User kann eigene INSERT + SELECT, Admin kann alle SELECT + UPDATE
- E-Mail-Benachrichtigung: Supabase Edge Function `notify-admin` → Resend API
- Database Webhook triggert Edge Function bei INSERT
- SQL-Setup: `docs/supabase-messages-setup.sql`
- Edge Function: `supabase/functions/notify-admin/index.ts`

### `user_pins`
| Spalte | Typ | Beschreibung |
|--------|-----|-------------|
| id | uuid | PK |
| user_id | uuid | User (auth.uid), FK → auth.users |
| item_id | text | ID des Ordners oder der Notiz |
| item_type | text | `'folder'` oder `'note'` |
| created_at | timestamptz | Zeitstempel |

- **Pro-User Fixierungen**: Jeder User hat seine eigenen Pins
- UNIQUE(user_id, item_id) — ein User kann ein Element nur einmal pinnen
- RLS: User sieht/verwaltet nur eigene Pins (SELECT, INSERT, DELETE)
- SQL-Setup: `docs/supabase-user-pins-setup.sql`
- Ersetzt die alte globale `pinned`-Spalte in `folders` und `notes`

## Berechtigungs-System

### Admin
- Definiert in `lib/admin.ts` via `ADMIN_EMAILS` (aktuell: `tunehelm@gmail.com`)
- Kann ALLES: Ordner erstellen/löschen, Schreibschutz setzen, Inhalte bearbeiten
- Kann readonly-Ordner trotzdem bearbeiten

### Alle Team-Mitglieder (inkl. Nicht-Admins)
- Können Ordner und Notizen erstellen (Dashboard + FolderPage Create-Buttons für alle sichtbar)
- Können ihre **eigenen** Ordner/Notizen löschen, verschieben, umbenennen
- Können Notizen in Team-Ordnern editieren (Inhalt bearbeiten)
- Können ihre eigenen Pins verwalten (jeder sieht nur seine Fixierungen)
- Dürfen **NICHT**: Admin-erstellte Ordner/Notizen verschieben, löschen oder umbenennen
- Dürfen **NICHT**: Ordner anderer Team-Mitglieder umbenennen/löschen

### Berechtigungs-Checks im Code
- `canCreateHere`: `!isReadonly` — Jeder in nicht-readonly Ordnern (FolderPage)
- `canManageFolder`: `isOwner || isAdmin` — Umbenennen, Löschen, Zugriffsrechte (FolderPage)
- `canManageNote(ownerId)`: Per-Notiz Check — nur Ersteller oder Admin (FolderPage, Sidebar)
- `canDragNote(ownerId)`: Nur eigene Notizen oder Admin (Sidebar)
- `canDropInFolder(access)`: Nicht in readonly Ordner (Sidebar)
- `canDelete`: `isOwner || isAdmin` (NotePage — Löschen & Verschieben)

### Readonly-Ordner (`kind = 'readonly'`)
- **Ancestor-Chain-Check**: Wenn ein Elternordner readonly ist, sind ALLE Unterordner/Notizen ebenfalls readonly
- Prüfung erfolgt in `FolderPage.tsx` und `NotePage.tsx` durch rekursive Parent-Traversierung
- Nicht-Admins dürfen in readonly-Ordnern NUR: lesen, fixieren, teilen, herunterladen
- Nicht-Admins dürfen NICHT: umbenennen, bearbeiten, verschieben, löschen, neue Elemente erstellen
- `updateFolderAccess()` setzt den Status rekursiv auf alle Unterordner

### Private Ordner (`kind = 'private'`)
- Nur sichtbar für den Ersteller (`owner_id`)

## RLS (Row Level Security) — BEKANNTE PROBLEME
- RLS-Policies in Supabase müssen mit der Frontend-Logik übereinstimmen
- Bei Updates kann RLS den Schreibzugriff blockieren → `api.ts` hat Fallback-Logik (Zeile ~667)
- Wenn RLS-Fehler auftreten: IMMER zuerst die Supabase-Policies prüfen, nicht nur den Frontend-Code
- Spalten-Fallbacks existieren für `icon` (ältere DB-Versionen ohne diese Spalte)

## Wichtige Code-Stellen

| Datei | Verantwortung |
|-------|---------------|
| `lib/api.ts` | Alle Supabase CRUD-Operationen, User-Pins API |
| `lib/admin.ts` | Admin-E-Mail-Check |
| `state/AppDataContext.tsx` | Globaler State, optimistic Updates, Profil-Upsert bei Login |
| `state/appDataStore.ts` | TypeScript Interfaces |
| `data/mockData.ts` | FolderItem/NoteItem Interfaces, Sortier-Hilfsfunktionen |
| `components/FolderIcons.tsx` | Icon-System, `getStableColor(id)`, NoteIcon, Sales-Icons |
| `components/Sidebar.tsx` | Sidebar mit DnD (Notizen + Ordner-Reihenfolge), User-Menü, Namensänderung |
| `components/MoveNoteModal.tsx` | Notiz verschieben Dialog |
| `components/UserAvatar.tsx` | Avatar mit stabilen Initialen + Farben aus Profil-Daten |
| `pages/FolderPage.tsx` | Ordner-Ansicht mit Berechtigungs-Checks |
| `pages/NotePage.tsx` | Note-Editor (contenteditable), Zeichnen, Bild einfügen/löschen/resize, Symbol-Palette |
| `pages/DashboardPage.tsx` | Start-Übersicht, fixierte Karten, Profil-Lookup für Avatare |
| `pages/TeamHubPage.tsx` | Team-Mitglieder, Nachricht an Admin, Admin-Nachrichteneingang |
| `pages/SearchPage.tsx` | Suche mit Profil-Lookup für Avatare |
| `pages/PrivatePage.tsx` | Private Ordner/Notizen |
| `supabase/functions/notify-admin/index.ts` | Edge Function: E-Mail via Resend bei neuer Nachricht |

## UI-Konventionen
- Ordner = immer einheitliches Ordner-Icon (farbige Outlines, kein Backdrop)
- Notizen = immer NoteIcon (Dokument mit dünnen Textlinien, strokeWidth 1.3/0.75)
- **Stabile Farben**: `getStableColor(id)` berechnet Farbe per ID-Hash — gleicher Ordner = gleiche Farbe überall
- Schloss-Icon für Readonly = h-2.5 w-2.5, nur Outline, in `<span title="Nur Lesen">` gewrappt
- Karten-Layout mit `gap-3` überall (Dashboard, FolderPage, PrivatePage)
- Fixierte Karten: kompakt (w-40, p-2.5, nur Avatar + Titel + Excerpt)
- Sidebar Ordner-Reihenfolge via localStorage (`sidebar-folder-order`)
- Bilder im Editor: löschbar per rotem X-Button oder Delete/Backspace-Taste
- Headings (H1/H2/H3) als Inline-Spans mit font-size, nicht als Block-Elemente
- Toolbar: sticky top im Header (Bottom-Ansatz auf iOS nicht machbar wegen nativer Input-Leiste)

## Externe Dienste
- **Vercel**: Hosting + Deployment (auto-deploy bei git push)
- **Supabase**: Auth, Database, Storage, Edge Functions
- **Resend**: E-Mail-Versand (API-Key als Supabase Secret `RESEND_API_KEY`)
