# ARCHITECTURE.md — PWA Team-Notizen (Supabase + Vite/React)

Diese Datei ist die verbindliche Quelle für Architektur, Datenmodell, Rechte, UI-Regeln und Arbeitsweise.
Wenn etwas unklar ist: erst in dieser Datei nachsehen, dann implementieren.

## Ziele
- Apple-ähnliche, ruhige, professionelle Team-Notizen-App (PWA)
- Private Notizen + Team-Kollaboration
- Offline-fähiges Schreiben (mindestens lokal), Sync mit Supabase
- Owner-only Löschen, Papierkorb + Wiederherstellen, Auto-Purge nach 7 Tagen
- Pin/Unpin von Ordnern/Projekten/Notizen
- Bilder hochladen und einfügen
- Tabellen (mind. einfache Tabellen, wie Apple Notes “ähnlich”)
- Export (PDF, E-Mail/Share, optional Markdown)

## UI-Referenzen (Assets)
Im Ordner `assets/` liegen Referenzbilder, die den Stil und Aufbau vorgeben:
- Dashboard + Dashboard scroll runter
- Layout-Idee (clean/tidy)
- Notizen (Text, Bilder, Emojis, Diktieren iOS, Formatierung)
- Unterordner (zusätzliche Ebene)
- App-Icon und App-Icon2
- Privat-Ansicht
- Suchfeld-Ansicht
- Team-Ansicht
Diese Bilder dienen als visuelle Leitlinie für:

- Layout-Struktur
- Abstände & Hierarchie
- Ordner-Stil
- Farbwirkung
- Apple-ähnliche UX

Sie sind keine pixelgenaue Kopiervorgabe, sondern stilistische Referenz.

## UX/UI Regeln (verbindlich)
1) Hintergrund: sanftes, beruhigendes Hellblau (nicht aufdringlich).
2) Cards/Ordner: modern, heben sich vom Hintergrund ab, Apple-harmonisch.
3) Bottom Navigation:
   - In Listen-/Dashboard-Views sichtbar (große Touch Targets, Abstand, min 44x44).
   - In der Notiz/Editor-Ansicht NICHT unten (weil Tastatur). Dort: Editor-Toolbar oben/fixed.
4) Notiz-Editor:
   - Schreiben muss immer möglich sein.
   - Formatierung (Bold, Italic, Underline, Liste) muss visuell “aktiv” togglen (z.B. Icon-Status).
   - Undo/Redo dauerhaft verfügbar (oben).
5) Pin/Unpin:
   - In “…” Menü oder sichtbar als Pin-Button.
   - Muss in Ordner/Notiz/Projekt funktionieren (wo vorgesehen).
6) Umbenennen:
   - Alle Ordner/Notizen müssen benannt/umbenannt werden können.
7) Löschen:
   - Nur Owner darf löschen.
   - Löschen verschiebt in Papierkorb (Restore möglich).
8) Plattform:
   - iPhone: “App-like” (PWA Add-to-Home). Keine überlappende UI mit Tastatur.
   - Desktop/Surface: ebenfalls gutes Layout (Responsive).

## Rollen & Rechte (V1 = Owner-only, V2 = Team)
### V1 (jetzt, bereits live):
- Jede Zeile hat `owner_id`.
- RLS: nur owner kann sehen/ändern/löschen.
- Papierkorb: separate Trash-Tabellen, Auto-Purge.

### V2 (Team-Kollaboration):
- Team-Mitglieder dürfen in Notizen mitwirken.
- Owner bleibt “Eigentümer” und darf löschen.
- Team-Mitglieder dürfen NICHT löschen (nur bearbeiten/kommentieren je nach Rolle).

## Datenmodell (DB: Supabase Postgres)

### Tabellen (V1)
- `public.folders`
  - id uuid PK
  - title text
  - pinned boolean
  - created_at timestamptz
  - owner_id uuid FK -> auth.users

- `public.notes`
  - id uuid PK
  - folder_id uuid FK -> folders.id (nullable möglich)
  - title text
  - content jsonb (aktuell)  **Hinweis:** Wenn Editor HTML-String speichert, später ggf. auf TEXT umstellen.
  - pinned boolean
  - created_at timestamptz
  - updated_at timestamptz (Trigger)
  - owner_id uuid FK -> auth.users

- `public.trash_folders`
  - id uuid PK
  - title text
  - pinned boolean
  - created_at timestamptz
  - owner_id uuid FK -> auth.users
  - deleted_at timestamptz

- `public.trash_notes`
  - id uuid PK
  - folder_id uuid (optional)
  - title text
  - content jsonb
  - pinned boolean
  - created_at, updated_at
  - owner_id uuid FK -> auth.users
  - deleted_at timestamptz

### Trigger
- `notes.updated_at` wird bei UPDATE gesetzt.

### Papierkorb Auto-Purge
- Funktion: `public.purge_trash()`
- Cron: `purge-trash-daily` (03:00) wurde eingerichtet (Job-ID existiert).
- Erwartung: items älter als 7 Tage werden gelöscht.

## RLS Policies (V1)
Owner-only:
- SELECT/INSERT/UPDATE/DELETE nur wenn `owner_id = auth.uid()`
Gilt für: folders, notes, trash_folders, trash_notes.

## Auth
Zielzustand:
- App merkt Login persistent (kein “ständig per Email”).
- V1: Magic Link/OTP bleibt möglich, aber:
  - Session persistieren (Supabase client defaults)
  - Auth-Gate: nach Login direkt in App, nicht ständig neu anfordern

Optional (wenn du es willst, später):
- “Registrieren einmal” = E-Mail + Passwort ODER Passkeys (wenn sinnvoll).
- Team-Invite: Admin lädt per E-Mail ein, danach normaler Login.

## Dateien / Projektstruktur (Frontend)
Stack:
- Vite + React + TS
- React Router
- Tailwind
- vite-plugin-pwa
- Supabase JS Client

UI Komponenten:
- BottomNavigation (nur wo passend)
- Pages: Dashboard, Folder, Note
- Editor: Toolbar oben, Content darunter

## Offline / Persistenz
Minimum (jetzt):
- UI soll auch offline nutzbar sein (PWA cached shell).
- Daten: lokales Caching/optimistic UI möglich.

Next:
- Offline-first local store (IndexedDB) + Sync Queue.
- Konfliktstrategie: “last saved wins” + Hinweisbanner.

## Uploads
- Bilder via Supabase Storage (Bucket z.B. `note-images`)
- RLS: nur Owner lesen/schreiben (V1), später Team-Rollen.

## Exporte
- PDF Export (client-side render) oder serverless
- Share via E-Mail (mailto / Web Share API)

## UI Varianten
Wir unterstützen 2–3 UI-Varianten (A/B/C), die nur Styling/Layout betreffen.
Funktionalität bleibt identisch.

## Definition of Done (jede Änderung)
- läuft im Browser (localhost)
- läuft auf iPhone (Vercel URL + Add to Home)
- Buttons klickbar, keine Overlay-blocker
- keine Console errors in DevTools